name: Unity CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  unity-tests-windows:
    name: Unity Tests with API Integration (Windows)
    runs-on: windows-latest
    permissions:
      contents: read
      actions: write
      checks: write
    
    steps:
    - name: Checkout Unity project
      uses: actions/checkout@v4
      with:
        path: unity-project
        
    - name: Checkout MyCore API
      uses: actions/checkout@v4
      with:
        repository: hiskiapp/MyCore
        path: mycore-api
        
    - name: Setup PostgreSQL
      uses: ankane/setup-postgres@v1
      with:
        database: mycoredb
        
    - name: Setup .NET for API
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore API dependencies
      working-directory: mycore-api
      run: dotnet restore
      
    - name: Build API
      working-directory: mycore-api
      run: dotnet build --no-restore --configuration Release
      
    - name: Start API in background
      working-directory: mycore-api
      shell: pwsh
      env:
        ConnectionStrings__DefaultConnection: "Host=localhost;Database=mycoredb;Username=postgres;Password="
        ASPNETCORE_URLS: "http://+:5018"
      run: |
        # Start API in background
        $process = Start-Process dotnet -ArgumentList "run --project MyCore.Api/MyCore.Api.csproj --no-build --configuration Release" -PassThru
        echo "API_PID=$($process.Id)" >> $env:GITHUB_ENV
        Write-Host "API started with PID: $($process.Id)"
        
        # Wait for API to be ready (reduced timeout)
        Write-Host "Waiting for API to start..."
        for ($i = 0; $i -lt 30; $i++) {
          try {
            $res = Invoke-WebRequest -Uri http://127.0.0.1:5018/pets -UseBasicParsing -ErrorAction SilentlyContinue
            if ($res.StatusCode -eq 200) {
              Write-Host "API is ready!"
              break
            }
          }
          catch { }
          Write-Host "Attempt $($i + 1): API not ready yet, waiting..."
          Start-Sleep -s 1
        }
        
        # Verify API is responding
        Write-Host "Testing API endpoint:"
        try {
          $response = Invoke-WebRequest -Uri http://127.0.0.1:5018/pets
          Write-Host "API Response: $($response.StatusCode)"
        }
        catch {
          Write-Host "API test failed: $_"
        }
        
    - name: Cache Unity Library
      uses: actions/cache@v4
      with:
        path: |
          unity-project/Library
          unity-project/Temp
        key: Unity-${{ runner.os }}-${{ hashFiles('unity-project/Packages/manifest.json', 'unity-project/ProjectSettings/ProjectVersion.txt') }}
        restore-keys: |
          Unity-${{ runner.os }}-
          
    # Skip Unity setup for test job - unity-test-runner handles it automatically
        
    - name: Run Unity Tests
      uses: game-ci/unity-test-runner@v4
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        API_URL: "http://host.docker.internal:5018/pets"
      with:
        projectPath: unity-project
        githubToken: ${{ secrets.GITHUB_TOKEN }}
        customParameters: -logFile - -batchmode -quit
        artifactsPath: TestResults
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unity-test-results-windows
        path: |
          unity-project/artifacts
          unity-project/TestResults
          unity-project/Logs
        if-no-files-found: warn
        
    - name: Stop API
      if: always()
      shell: pwsh
      run: |
        if ($env:API_PID) {
          Write-Host "Stopping API with PID: $env:API_PID"
          try {
            Stop-Process -Id $env:API_PID -Force
          }
          catch {
            Write-Host "Failed to stop API process: $_"
          }
        }

  build-unity-windows:
    name: Build Unity Project (Windows)
    runs-on: windows-latest
    needs: unity-tests-windows
    permissions:
      contents: read
      actions: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache Unity Library
      uses: actions/cache@v4
      with:
        path: |
          Library
          Temp
        key: Unity-${{ runner.os }}-${{ hashFiles('Packages/manifest.json', 'ProjectSettings/ProjectVersion.txt') }}
        restore-keys: |
          Unity-${{ runner.os }}-
          
    - name: Build Unity Project
      uses: game-ci/unity-builder@v4
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        targetPlatform: StandaloneWindows64
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: unity-build-windows
        path: build
